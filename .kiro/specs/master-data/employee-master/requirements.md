# 社員マスタ要求仕様

## 1. コンテキスト / スコープ

- **機能名**: 社員マスタ登録（一覧/新規/編集/無効化）
- **Feature ID**: `master-data/employee-master`
- **目的**: 本EPM SaaSにおいて、テナントごとの社員情報を管理し、他機能（権限管理や将来の計画・実績入力）の前提となる「社員マスタ」を提供する。
- **スコープ**:
  - 社員の登録（Create）
  - 社員の一覧・検索（Read）
  - 社員情報の編集（Update）
  - 社員の無効化（論理削除相当 / Inactivate）
- **非スコープ**:
  - 認証基盤（Clerk等）とのアカウント連携・SSO連携
  - 申請・承認ワークフロー
  - CSV / Excel 等による一括取込・一括更新
  - 組織マスタ・ロールマスタとの高度な連動（本Featureでは「参照用のキー」を持つ前提にとどめる）

## 1.5 Decision Tasks（Open Questions / 未確定点）
以下は design.md で確定し、確定後に本requirementsへ反映する。

- [D1] 社員コード（employee_code）の仕様
  - 形式（文字種・桁数・プレフィックス有無）
  - 採番（完全手入力 / 自動採番 / 混在）
  - 変更可否（変更禁止が基本か、例外を許すか）

- [D2] 社員マスタの「必須項目」最終確定
  - 氏名の持ち方（姓/名分離 or フルネーム1項目）
  - 所属組織の扱い（org_id必須か、未所属許容か）
  - 連絡先（email）を必須にするか任意にするか

- [D3] 無効化社員の扱い（MVP方針）
  - 無効社員の編集：MVPでは原則禁止（参照のみ）で良いか
  - 再有効化（reactivate）はMVP外で良いか

---

## 2. 要件一覧（EARS形式）

※ 各要件IDは後続の design.md / tasks.md / テストケースから参照される。

### 1. 登録（Create）

- **1.1**:  
  *When* 権限を持つユーザーが社員マスタの「新規登録」操作を行うとき、  
  *the system shall* 社員コード・氏名（姓/名または氏名フリーフォーマット）・所属組織・在籍ステータス（有効/無効）などの必須項目を入力させ、必須項目がすべて入力されている場合のみ登録を許可する。

- **1.2**:  
  *When* 権限を持つユーザーが既存の社員コードで新規登録を試みたとき、  
  *the system shall* 当該テナント内で社員コードの一意制約違反として登録を拒否し、ユーザーに分かりやすいエラーを表示する。

- **1.3**:  
  *When* ユーザーが登録フォームを送信したとき、  
  *the system shall* tenant_id を含めて社員レコードを保存し、登録処理の結果（成功/失敗）をユーザーに返す。
  

### 2. 一覧・検索（Read）

- **2.1**:  
  *When* ユーザーが社員マスタ画面を開いたとき、  
  *the system shall* 当該テナントの社員レコードのみを一覧表示する。

- **2.2**:  
  *When* ユーザーが社員名・社員コード・所属組織・在籍ステータスなどの検索条件を指定したとき、  
  *the system shall* 指定された条件で当該テナント内の社員レコードをフィルタリングして表示する。

- **2.3**:  
  *When* ユーザーが一覧画面を閲覧するとき、  
  *the system shall* デフォルトで「有効な社員」のみを表示し、ユーザーが明示的に切り替えた場合に限り「無効を含む」表示を行う。

- **2.4**:
  *When* ユーザーが社員一覧を閲覧するとき、
  *the system shall* ソート（既定: 社員コード昇順）およびページング（既定: 50件/ページ等）を提供する。

### 3. 編集（Update）

- **3.1**:  
  *When* 権限を持つユーザーが既存社員の編集画面を開いたとき、  
  *the system shall* 最新の社員情報をフォームに読み込み、変更可能な項目のみ編集させる。

- **3.2**:  
  *When* ユーザーが社員情報の編集内容を保存したとき、  
  *the system shall* 入力値のバリデーションを行い、正しい場合にのみ対象レコードを更新する。

- **3.3**:  
  *When* ユーザーが社員コードを変更しようとしたとき、  
  *the system shall* 当該テナント内の一意性を再度検証し、重複がある場合は更新を拒否する。

### 4. 無効化（Inactivate）

- **4.1**:  
  *When* 権限を持つユーザーが社員を「無効化」する操作を行うとき、  
  *the system shall* 社員レコードの「在籍ステータス」や「有効フラグ」を更新することで論理的に無効化し、物理削除は行わない。

- **4.2**:  
  *When* 社員が無効化されている場合、  
  *the system shall* デフォルトの一覧表示や選択肢（ドロップダウン等）からは除外するが、必要に応じて「無効を含めて表示」することで参照できるようにする。

- **4.3**:  
  *When* 無効化済み社員について編集操作が行われるとき、  
  *the system shall* 設計で許可された項目（例: 備考、退職日等）のみ編集可能とし、再入社などの取り扱いは本Featureスコープ外とすることを明示する。

### 5. 権限・認可

- **5.1**:  
  *When* 社員マスタ画面へのアクセスリクエストがあるとき、  
  *the system shall* 当該ユーザーが社員マスタ参照権限（例: `epm.user.read` 相当）を持つ場合にのみ一覧表示を許可する。

- **5.2**:  
  *When* 社員の登録・編集・無効化操作がリクエストされたとき、  
  *the system shall* 当該ユーザーが社員マスタ更新権限（例: `epm.user.update` 相当）を持つ場合にのみ処理を実行し、権限がない場合は処理を拒否する。

- **5.3**:
  *When* ユーザーが参照権限のみを持つ場合、
  *the system shall* UI上で更新系操作（新規/編集/無効化）を表示しない、または無効化し、APIは権限不十分として拒否する。

### 6. 監査・履歴

- **6.1**:  
  *When* 社員レコードが新規登録・編集・無効化されたとき、  
  *the system shall* 「誰が・いつ・何を・どの値からどの値へ」変更したかを特定できる監査情報を保持する。

- **6.2**:  
  *When* 監査ログが記録されるとき、  
  *the system shall* 最低限 tenant_id / user_id / 対象リソース（社員ID）/ 操作種別（作成・更新・無効化）/ 結果（成功・失敗）を含める。

### 7. マルチテナント

- **7.1**:  
  *When* 社員データへアクセスするあらゆる処理が実行されるとき、  
  *the system shall* 常に tenant_id をスコープとして扱い、他テナントの社員データにアクセスできないようにする。

- **7.2**:  
  *When* 社員レコードが作成・更新されるとき、  
  *the system shall* tenant_id を必須として保持し、Row Level Security（RLS）の前提を満たす形で保存する。

---

## 3. 受入条件（Given / When / Then）

### 1. 社員の新規登録

- **AC1-1 正常系（新規社員登録）**  
  - *Given* 社員マスタ更新権限を持つユーザーがログインしており、社員コード・氏名・所属組織・在籍ステータス「有効」を入力している  
  - *When* ユーザーが「登録」ボタンを押す  
  - *Then* システムは当該テナントの社員テーブルに新規レコードを作成し、一覧画面に新規社員が表示される

- **AC1-2 異常系（社員コード重複）**  
  - *Given* 既に同一テナント内に「E001」という社員コードの社員が存在している  
  - *When* ユーザーが「E001」を社員コードとして新規登録しようとし、「登録」ボタンを押す  
  - *Then* システムは登録を拒否し、「社員コードが重複しています」等のエラーメッセージを表示し、既存レコードは変更されない

### 2. 社員一覧・検索

- **AC2-1 デフォルト一覧**  
  - *Given* 社員マスタ参照権限を持つユーザーがログインしている  
  - *When* ユーザーが社員マスタ画面を開く  
  - *Then* システムは当該テナント内の「有効な社員」のみを社員コード昇順などの既定順序で表示する

- **AC2-2 条件検索**  
  - *Given* 社員マスタ画面が表示されており、社員名に「田中」と入力している  
  - *When* ユーザーが「検索」ボタンを押す  
  - *Then* システムは社員名に「田中」を含む社員のみを一覧表示する

### 3. 編集

- **AC3-1 編集の保存**  
  - *Given* 社員マスタ更新権限を持つユーザーが、既存社員「E001」の編集画面を開き、所属組織を「営業一部」から「営業二部」に変更している  
  - *When* ユーザーが「保存」ボタンを押す  
  - *Then* システムは社員テーブル上の該当レコードを更新し、一覧画面でも所属組織が「営業二部」と表示される

### 4. 無効化

- **AC4-1 無効化の反映**  
  - *Given* 社員マスタ更新権限を持つユーザーが、社員「E001」の詳細画面で在籍ステータスを「無効」に変更している  
  - *When* ユーザーが「保存」ボタンを押す  
  - *Then* システムは社員レコードの在籍ステータスを「無効」に更新し、通常の社員一覧（デフォルト表示）からは「E001」が表示されなくなる

- **AC4-2 無効を含む表示**  
  - *Given* 上記のように「E001」が無効化されている  
  - *When* ユーザーが一覧画面で「無効を含めて表示」のフィルタを有効にする  
  - *Then* システムは無効社員「E001」も含めて一覧表示する

### 5. 権限制御

- **AC5-1 参照権限なし**  
  - *Given* 社員マスタ参照権限を持たないユーザーがログインしている  
  - *When* 当該ユーザーが社員マスタ画面のURLへ直接アクセスしようとする  
  - *Then* システムはアクセスを拒否し、権限エラー画面またはメッセージを表示する（詳細は design.md で定義）

- **AC5-2 更新権限なし**  
  - *Given* 社員マスタ参照権限のみを持つユーザーが、社員一覧画面を開いている  
  - *When* ユーザーが社員編集画面へ遷移しようとする、または編集APIを呼び出そうとする  
  - *Then* システムは編集操作を無効化または拒否し、社員データは変更されない

---

## 4. ビジネスルール

1. 社員コードはテナント内で一意でなければならない。  
2. 社員レコードは原則として物理削除してはならず、無効化により取り扱う。  
3. 在籍ステータス（有効/無効）は、他機能（例: 将来の入力画面での選択肢）からの参照を前提とする。  
4. 社員マスタの属性項目（氏名、所属組織、メールアドレスなど）の詳細は design.md で定義し、本ファイルでは振る舞いにフォーカスする。

---

## 5. 非機能要件（本Featureに関わる範囲）

1. **パフォーマンス**:  
   - 1テナントあたり数千件程度の社員レコードを想定し、一覧表示や検索が実用的な速度（数秒以内）で完了すること。

2. **監査性**:  
   - 監査ログにより、社員の登録・編集・無効化の操作履歴を追跡できること。

3. **マルチテナント安全性**:  
   - いかなるAPI / 画面からも、他テナントの社員データが閲覧・更新されないこと（RLS前提）。

4. **権限制御**:  
   - UIとAPIの両方で権限制御が一貫しており、UIで表示されていない操作がAPI経由で実行できないこと。

---

本 requirements.md は、`master-data/employee-master` の設計（design.md）およびタスク分解（tasks.md）の前提となる要求仕様であり、  
変更が必要な場合は本ファイルを更新した上で後続フェーズに反映する。

