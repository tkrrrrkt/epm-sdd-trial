## 1. アーキテクチャ概要

### 1.1 プラットフォーム（確定）

- **Frontend**：Next.js + Tailwind CSS
    
- **Backend**：Node.js（NestJS）
    
- **Database**：**Azure Cosmos DB for PostgreSQL**
    
- **Cloud**：Microsoft Azure
    
    - Container Apps（実行基盤）
        
    - Cosmos DB for PostgreSQL（DB）
        
    - Azure OpenAI（AI機能）
        
    - Application Insights（監視・可観測性）
        
    - ARM Template（IaC / 環境再現性）
        

### 1.2 その他利用サービス（採用前提）

- **Clerk**：認証（MFA/SSO含む）
    
- **SpreadJS**：Excel UI（入力体験の強化）
    
- **Cube Cloud**：多次元集計（OLAP/セマンティックレイヤ）
    
- **SonarQube**：静的解析/脆弱性検出
    
- **Corsor OR ClaudeCode**：コード生成支援（開発生産性）
    

---

## 2. 重要な設計原則（ここだけは全員が守る）

### 2.1 バックエンドは “Single Source of Enforcement”

- **業務データの作成・更新・削除は原則すべて NestJS API 経由**
    
- 理由：認可、監査、テナント分離、外部連携、将来拡張を **API層で一元統制**するため
    
- UI（Next.js）は業務ルールを抱え込まない（分散させない）
    

### 2.2 マルチテナントは “二重防御（Defense in Depth）”

- **アプリ層**：tenant_id をリクエストコンテキストから取得し、Repositoryまで明示的に伝播
    
- **DB層**：RLS（Row Level Security）適用を前提に行レベルで防御
    
    - ※RLSの設定方法（セッション変数や接続時の設定）は infra の責務として閉じ込める
        

### 2.3 契約（DTO/Enum/Error）をSSoT化する

- API と Frontend の間で `any` を増やさないため、**契約定義を共通化**する
    
- 「UIが先」でも「APIが先」でも、最終的に **契約を正**として整合させる
    

---

## 3. Frontend（Next.js）方針：UIは速く、でもルールは持たない

### 3.1 役割

- 画面構築、入力支援、表示最適化（SSR/Streaming等）
    
- 認証UI（Clerk連携）
    
- SpreadJS による Excel ライク入力（予算/見込/購買明細など、対象は別途定義）
    

### 3.2 Server Actions の扱い（原則）

- **更新系は API（NestJS）へ**
    
- Server Actions は原則「UI補助」「参照系」に限定
    
    - 例：画面状態、入力補助、SSR用途の軽量参照
        

### 3.3 観測性（最低限）

- すべてのAPI呼び出しに相関ID（request_id/trace_id）を付与して追えるようにする
    
- フロントの例外も App Insights に集約（JS例外・パフォーマンス）
    

---

## 4. Backend（NestJS）方針：モジュラーモノリスで境界を守る

### 4.1 アーキテクチャスタイル

- **モジュラーモノリス（1 repo / 1 deploy）** を基本
    
- ドメイン単位に Module 分割し、将来の分割余地を残す（最初から分割しない）

### 4.2 認可（Authorization）の責務境界

- Controller は入口整形（認証済み、tenant取得）まで
    
- **最終判断は UseCase/Application 層**（業務ルールの分散防止）
    
- RBAC だけでなく「組織階層・金額閾値・状態」等の拡張を前提に設計
    

---

## 6. データ基盤：Cosmos DB for PostgreSQL を前提にした扱い

### 6.1 前提

- 業務データの正本は **Cosmos DB for PostgreSQL**
    
- マルチテナントは tenant_id +（RLS前提）
    
- マイグレーション/IaCで再現可能にする（ARM Template と併せて環境差異を減らす）
    

### 6.2 分析（Cube Cloud）の位置づけ

- **多次元集計・経営分析は Cube Cloud 側で最適化**
    
- 役割分担
    
    - DB：トランザクション（正本）
        
    - Cube：集計/セマンティックレイヤ/分析API
        
- データ同期方式（ETL/ELT/CDC）は **別紙で確定**（ここでは“採用する”のみ合意）
    

---

## 7. 認証・セキュリティ：Clerkを“認証の正”にする

### 7.1 基本方針

- 認証（ログイン/MFA/SSO）は **Clerk が正**
    
- アプリ側は以下を正とする
    
    - テナント・組織・ロール/権限・業務認可
        
    - 監査ログ（誰が何をしたか）
        
    - データ分離（tenant_id + RLS）
        